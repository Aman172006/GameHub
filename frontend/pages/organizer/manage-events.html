<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Events - GameHub</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/dashboard.css">
    <link rel="stylesheet" href="../../assets/css/events.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-body">
    <!-- Dashboard Layout -->
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <div class="brand-logo">
                    <i class="fas fa-crown"></i>
                    <span>ORGANIZER</span>
                </div>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <div class="sidebar-user">
                <div class="user-avatar">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="user-info" id="sidebar-user-info">
                    <div class="user-name">Loading...</div>
                    <div class="user-role">Organizer</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="create-event.html" class="nav-link">
                            <i class="fas fa-plus-circle"></i>
                            <span>Create Event</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="manage-events.html" class="nav-link">
                            <i class="fas fa-cogs"></i>
                            <span>Manage Events</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="registrations.html" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span>Registrations</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="event-analytics.html" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="../shared/profile.html" class="nav-link">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </a>
                    </li>
                </ul>
                
                <div class="sidebar-footer">
                    <button class="btn-logout" onclick="auth.logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Header -->
            <header class="dashboard-header">
                <div class="header-left">
                    <h1 class="page-title">
                        <i class="fas fa-cogs"></i>
                        Manage Events
                    </h1>
                    <p class="page-subtitle">Monitor and control your gaming tournaments</p>
                </div>
                
                <div class="header-right">
                    <div class="header-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="total-events">0</div>
                            <div class="stat-label">Total Events</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="active-events">0</div>
                            <div class="stat-label">Active</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="draft-events">0</div>
                            <div class="stat-label">Drafts</div>
                        </div>
                    </div>
                    
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="refreshEvents()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn-primary" onclick="createNewEvent()">
                            <i class="fas fa-plus"></i>
                            Create Event
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="dashboard-content">
                <!-- Event Filters -->
                <section class="filters-section">
                    <div class="filters-header">
                        <h3>Filter Events</h3>
                        <div class="filter-actions">
                            <button class="btn-outline btn-small" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                                Clear
                            </button>
                            <div class="view-toggle">
                                <button class="view-btn active" data-view="grid" onclick="switchView('grid')">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button class="view-btn" data-view="list" onclick="switchView('list')">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <select id="status-filter" class="filter-select" onchange="applyFilters()">
                                <option value="">All Statuses</option>
                                <option value="draft">Draft</option>
                                <option value="published">Published</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Category</label>
                            <select id="category-filter" class="filter-select" onchange="applyFilters()">
                                <option value="">All Categories</option>
                                <option value="FPS">FPS</option>
                                <option value="MOBA">MOBA</option>
                                <option value="Battle Royale">Battle Royale</option>
                                <option value="Sports">Sports</option>
                                <option value="Racing">Racing</option>
                                <option value="Strategy">Strategy</option>
                                <option value="Fighting">Fighting</option>
                                <option value="RPG">RPG</option>
                                <option value="Casual">Casual</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Date Range</label>
                            <select id="date-filter" class="filter-select" onchange="applyFilters()">
                                <option value="">All Dates</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="this-week">This Week</option>
                                <option value="next-week">Next Week</option>
                                <option value="this-month">This Month</option>
                                <option value="past">Past Events</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Registration</label>
                            <select id="registration-filter" class="filter-select" onchange="applyFilters()">
                                <option value="">All Events</option>
                                <option value="low">Low Registration (&lt;50%)</option>
                                <option value="good">Good Registration (50-80%)</option>
                                <option value="full">Nearly Full (&gt;80%)</option>
                                <option value="waiting">Waitlist Active</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Search</label>
                            <div class="search-input-container">
                                <input 
                                    type="text" 
                                    id="search-filter" 
                                    class="search-input" 
                                    placeholder="Search events..."
                                    oninput="debounceSearch()"
                                >
                                <i class="fas fa-search search-icon"></i>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Sort By</label>
                            <select id="sort-filter" class="filter-select" onchange="applyFilters()">
                                <option value="date-desc">Date (Newest First)</option>
                                <option value="date-asc">Date (Oldest First)</option>
                                <option value="created-desc">Created (Newest)</option>
                                <option value="created-asc">Created (Oldest)</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="participants-desc">Participants (Most)</option>
                                <option value="participants-asc">Participants (Least)</option>
                            </select>
                        </div>
                    </div>
                </section>

                <!-- Events List -->
                <section class="events-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <span id="events-count">Your Events</span>
                        </h2>
                    </div>
                    
                    <div class="events-container" id="events-container">
                        <!-- Events will be loaded here -->
                        <div class="loading-placeholder">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading your events...</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Bulk Actions Modal -->
    <div id="bulk-actions-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-tasks"></i> Bulk Actions</h3>
                <span class="modal-close" onclick="closeModal('bulk-actions-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="bulk-actions-content">
                    <p>Select an action to apply to <span id="selected-count">0</span> selected event(s):</p>
                    
                    <div class="bulk-action-buttons">
                        <button class="btn-primary" onclick="bulkPublish()">
                            <i class="fas fa-eye"></i>
                            Publish Events
                        </button>
                        <button class="btn-secondary" onclick="bulkUnpublish()">
                            <i class="fas fa-eye-slash"></i>
                            Unpublish Events
                        </button>
                        <button class="btn-outline" onclick="bulkDuplicate()">
                            <i class="fas fa-copy"></i>
                            Duplicate Events
                        </button>
                        <button class="btn-danger" onclick="bulkDelete()">
                            <i class="fas fa-trash"></i>
                            Delete Events
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('bulk-actions-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Event Quick Actions Modal -->
    <div id="quick-actions-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                <span class="modal-close" onclick="closeModal('quick-actions-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="quick-actions-content">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('quick-actions-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../config/api-config.js"></script>
    <script src="../../assets/js/api.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/utils.js"></script>
    <script src="../../assets/js/dashboard.js"></script>
    <script src="../../assets/js/events.js"></script>
    
    <script>
        let allEvents = [];
        let filteredEvents = [];
        let selectedEvents = new Set();
        let currentView = 'grid';
        let searchTimeout;
        let currentQuickActionEventId = null;

        // Initialize manage events page
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication and role
            if (!auth.requireOrganizer()) {
                return;
            }
            
            // Update user info in sidebar
            const user = auth.getCurrentUser();
            if (user) {
                updateSidebarUserInfo(user);
            }
            
            // Load events
            await loadMyEvents();
            
            // Setup bulk selection
            setupBulkSelection();
        });

        // Update sidebar user info
        function updateSidebarUserInfo(user) {
            const userInfo = document.getElementById('sidebar-user-info');
            if (userInfo) {
                userInfo.innerHTML = `
                    <div class="user-name">${user.name}</div>
                    <div class="user-role">${user.role}</div>
                `;
            }
        }

        // Load my events
        async function loadMyEvents() {
            try {
                showLoadingState('Loading your events...');
                
                const events = await api.getMyEvents();
                allEvents = events;
                filteredEvents = [...allEvents];
                
                // Update statistics
                updateEventStats();
                
                // Display events
                displayEvents();
                
            } catch (error) {
                console.error('Error loading events:', error);
                showEventsError();
            } finally {
                hideLoadingState();
            }
        }

        // Update event statistics
        function updateEventStats() {
            const total = allEvents.length;
            const active = allEvents.filter(event => 
                event.is_active && new Date(event.date) > new Date()
            ).length;
            const drafts = allEvents.filter(event => 
                event.status === 'draft' || !event.is_active
            ).length;
            
            document.getElementById('total-events').textContent = total;
            document.getElementById('active-events').textContent = active;
            document.getElementById('draft-events').textContent = drafts;
        }

        // Display events
        function displayEvents() {
            const container = document.getElementById('events-container');
            
            if (filteredEvents.length === 0) {
                if (allEvents.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-plus"></i>
                            <h3>No Events Created Yet</h3>
                            <p>Start organizing amazing gaming tournaments!</p>
                            <button class="btn-primary" onclick="createNewEvent()">
                                <i class="fas fa-plus-circle"></i>
                                Create Your First Event
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>No Matching Events</h3>
                            <p>Try adjusting your filters to find what you're looking for.</p>
                            <button class="btn-outline" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                                Clear Filters
                            </button>
                        </div>
                    `;
                }
                return;
            }
            
            if (currentView === 'grid') {
                displayEventsGrid();
            } else {
                displayEventsList();
            }
            
            updateEventsCount();
        }

        // Display events in grid view
        function displayEventsGrid() {
            const container = document.getElementById('events-container');
            
            container.innerHTML = `
                <div class="events-grid-view">
                    <div class="bulk-actions-bar" id="bulk-actions-bar" style="display: none;">
                        <div class="bulk-info">
                            <span id="bulk-selected-count">0</span> event(s) selected
                        </div>
                        <div class="bulk-buttons">
                            <button class="btn-outline btn-small" onclick="selectAllEvents()">
                                <i class="fas fa-check-double"></i>
                                Select All
                            </button>
                            <button class="btn-outline btn-small" onclick="clearSelection()">
                                <i class="fas fa-times"></i>
                                Clear
                            </button>
                            <button class="btn-primary btn-small" onclick="showBulkActionsModal()">
                                <i class="fas fa-tasks"></i>
                                Actions
                            </button>
                        </div>
                    </div>
                    
                    <div class="events-grid">
                        ${filteredEvents.map(event => createEventCard(event)).join('')}
                    </div>
                </div>
            `;
        }

        // Display events in list view
        function displayEventsList() {
            const container = document.getElementById('events-container');
            
            container.innerHTML = `
                <div class="events-list-view">
                    <div class="events-table-container">
                        <table class="events-table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" onchange="toggleSelectAll(this)">
                                    </th>
                                    <th>Event</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Participants</th>
                                    <th>Registration</th>
                                    <th>Revenue</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredEvents.map(event => createEventTableRow(event)).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Create event card for grid view
        function createEventCard(event) {
            const status = getEventStatus(event);
            const registrationProgress = getRegistrationProgress(event);
            const revenue = calculateRevenue(event);
            const isSelected = selectedEvents.has(event.id);
            
            return `
                <div class="event-card manage-card ${isSelected ? 'selected' : ''}" data-event-id="${event.id}">
                    <div class="event-card-header">
                        <div class="event-selection">
                            <input type="checkbox" class="event-checkbox" 
                                   onchange="toggleEventSelection(${event.id}, this.checked)" 
                                   ${isSelected ? 'checked' : ''}>
                        </div>
                        <div class="event-status-badge status-${status}">
                            ${getEventStatusText(status)}
                        </div>
                        <div class="event-quick-actions">
                            <button class="quick-action-btn" onclick="showQuickActions(${event.id})" title="Quick Actions">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="event-content">
                        <div class="event-category">${event.category}</div>
                        <h3 class="event-title">${event.title}</h3>
                        <p class="event-description">${StringUtils.truncate(event.description, 80)}</p>
                        
                        <div class="event-meta">
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>${DateUtils.formatDate(event.date)}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${event.location}</span>
                            </div>
                        </div>
                        
                        <div class="event-stats">
                            <div class="stat">
                                <span class="stat-label">Registered</span>
                                <span class="stat-value">${event.registered_count || 0}/${event.max_participants}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Progress</span>
                                <span class="stat-value">${registrationProgress}%</span>
                            </div>
                            ${event.entry_fee ? `
                                <div class="stat">
                                    <span class="stat-label">Revenue</span>
                                    <span class="stat-value">$${revenue}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="event-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${registrationProgress}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-actions">
                        <button class="btn-outline btn-small" onclick="viewEventDetails(${event.id})">
                            <i class="fas fa-eye"></i>
                            View
                        </button>
                        <button class="btn-secondary btn-small" onclick="editEvent(${event.id})">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                        <button class="btn-primary btn-small" onclick="viewRegistrations(${event.id})">
                            <i class="fas fa-users"></i>
                            ${event.registered_count || 0}
                        </button>
                    </div>
                </div>
            `;
        }

        // Create event table row for list view
        function createEventTableRow(event) {
            const status = getEventStatus(event);
            const registrationProgress = getRegistrationProgress(event);
            const revenue = calculateRevenue(event);
            const isSelected = selectedEvents.has(event.id);
            
            return `
                <tr class="event-row ${isSelected ? 'selected' : ''}" data-event-id="${event.id}">
                    <td>
                        <input type="checkbox" class="event-checkbox" 
                               onchange="toggleEventSelection(${event.id}, this.checked)" 
                               ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>
                        <div class="event-info">
                            <div class="event-title">${event.title}</div>
                            <div class="event-category">${event.category}</div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge status-${status}">
                            ${getEventStatusText(status)}
                        </span>
                    </td>
                    <td>${DateUtils.formatDate(event.date)}</td>
                    <td>
                        <span class="participants-count">
                            ${event.registered_count || 0}/${event.max_participants}
                        </span>
                    </td>
                    <td>
                        <div class="registration-progress">
                            <div class="progress-bar small">
                                <div class="progress-fill" style="width: ${registrationProgress}%"></div>
                            </div>
                            <span class="progress-text">${registrationProgress}%</span>
                        </div>
                    </td>
                    <td class="revenue-cell">
                        ${event.entry_fee ? `$${revenue}` : 'Free'}
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="action-btn" onclick="viewEventDetails(${event.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn" onclick="editEvent(${event.id})" title="Edit Event">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="viewRegistrations(${event.id})" title="View Registrations">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="action-btn" onclick="showQuickActions(${event.id})" title="More Actions">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Apply filters and search
        function applyFilters() {
            const statusFilter = document.getElementById('status-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            const registrationFilter = document.getElementById('registration-filter').value;
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();
            const sortFilter = document.getElementById('sort-filter').value;
            
            // Filter events
            filteredEvents = allEvents.filter(event => {
                // Status filter
                if (statusFilter && getEventStatus(event) !== statusFilter) return false;
                
                // Category filter
                if (categoryFilter && event.category !== categoryFilter) return false;
                
                // Date filter
                if (dateFilter && !matchesDateFilter(event.date, dateFilter)) return false;
                
                // Registration filter
                if (registrationFilter && !matchesRegistrationFilter(event, registrationFilter)) return false;
                
                // Search filter
                if (searchFilter && !matchesSearch(event, searchFilter)) return false;
                
                return true;
            });
            
            // Sort events
            sortEvents(sortFilter);
            
            // Display filtered results
            displayEvents();
        }

        // Filter helper functions
        function matchesDateFilter(eventDate, filter) {
            const event = new Date(eventDate);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (filter) {
                case 'upcoming':
                    return event > now;
                case 'this-week':
                    const endOfWeek = new Date(today);
                    endOfWeek.setDate(today.getDate() + (7 - today.getDay()));
                    return event >= today && event <= endOfWeek;
                case 'next-week':
                    const nextWeekStart = new Date(today);
                    nextWeekStart.setDate(today.getDate() + (7 - today.getDay()) + 1);
                    const nextWeekEnd = new Date(nextWeekStart);
                    nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                    return event >= nextWeekStart && event <= nextWeekEnd;
                case 'this-month':
                    return event.getMonth() === now.getMonth() && event.getFullYear() === now.getFullYear();
                case 'past':
                    return event < now;
                default:
                    return true;
            }
        }

        function matchesRegistrationFilter(event, filter) {
            const registrationProgress = getRegistrationProgress(event);
            
            switch (filter) {
                case 'low':
                    return registrationProgress < 50;
                case 'good':
                    return registrationProgress >= 50 && registrationProgress <= 80;
                case 'full':
                    return registrationProgress > 80;
                case 'waiting':
                    return event.has_waitlist || false; // Assuming this field exists
                default:
                    return true;
            }
        }

        function matchesSearch(event, search) {
            return event.title.toLowerCase().includes(search) ||
                   event.description.toLowerCase().includes(search) ||
                   event.category.toLowerCase().includes(search) ||
                   event.location.toLowerCase().includes(search);
        }

        // Sort events
        function sortEvents(sortType) {
            switch (sortType) {
                case 'date-asc':
                    filteredEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'date-desc':
                    filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'created-asc':
                    filteredEvents.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'created-desc':
                    filteredEvents.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'name-asc':
                    filteredEvents.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'name-desc':
                    filteredEvents.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case 'participants-asc':
                    filteredEvents.sort((a, b) => (a.registered_count || 0) - (b.registered_count || 0));
                    break;
                case 'participants-desc':
                    filteredEvents.sort((a, b) => (b.registered_count || 0) - (a.registered_count || 0));
                    break;
            }
        }

        // Search with debounce
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 300);
        }

        // View switching
        function switchView(view) {
            currentView = view;
            
            // Update buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            
            // Clear selection when switching views
            clearSelection();
            
            // Redisplay events
            displayEvents();
        }

        // Selection management
        function setupBulkSelection() {
            // This will be called when the page loads
        }

        function toggleEventSelection(eventId, isSelected) {
            if (isSelected) {
                selectedEvents.add(eventId);
            } else {
                selectedEvents.delete(eventId);
            }
            
            updateBulkActionsVisibility();
            updateSelectionDisplay();
        }

        function selectAllEvents() {
            filteredEvents.forEach(event => {
                selectedEvents.add(event.id);
            });
            
            // Update checkboxes
            document.querySelectorAll('.event-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            
            updateBulkActionsVisibility();
            updateSelectionDisplay();
        }

        function clearSelection() {
            selectedEvents.clear();
            
            // Update checkboxes
            document.querySelectorAll('.event-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            updateBulkActionsVisibility();
            updateSelectionDisplay();
        }

        function updateBulkActionsVisibility() {
            const bulkBar = document.getElementById('bulk-actions-bar');
            if (bulkBar) {
                bulkBar.style.display = selectedEvents.size > 0 ? 'flex' : 'none';
            }
        }

        function updateSelectionDisplay() {
            const countElement = document.getElementById('bulk-selected-count');
            if (countElement) {
                countElement.textContent = selectedEvents.size;
            }
        }

        // Bulk actions
        function showBulkActionsModal() {
            document.getElementById('selected-count').textContent = selectedEvents.size;
            openModal('bulk-actions-modal');
        }

        async function bulkPublish() {
            if (selectedEvents.size === 0) return;
            
            try {
                const eventIds = Array.from(selectedEvents);
                await Promise.all(eventIds.map(id => api.publishEvent(id)));
                
                showNotification(`${eventIds.length} event(s) published successfully!`, 'success');
                await loadMyEvents();
                clearSelection();
                closeModal('bulk-actions-modal');
                
            } catch (error) {
                console.error('Bulk publish error:', error);
                showNotification('Failed to publish some events. Please try again.', 'error');
            }
        }

        async function bulkUnpublish() {
            if (selectedEvents.size === 0) return;
            
            try {
                const eventIds = Array.from(selectedEvents);
                await Promise.all(eventIds.map(id => api.unpublishEvent(id)));
                
                showNotification(`${eventIds.length} event(s) unpublished successfully!`, 'success');
                await loadMyEvents();
                clearSelection();
                closeModal('bulk-actions-modal');
                
            } catch (error) {
                console.error('Bulk unpublish error:', error);
                showNotification('Failed to unpublish some events. Please try again.', 'error');
            }
        }

        async function bulkDuplicate() {
            if (selectedEvents.size === 0) return;
            
            if (!confirm(`Are you sure you want to duplicate ${selectedEvents.size} event(s)?`)) {
                return;
            }
            
            try {
                const eventIds = Array.from(selectedEvents);
                await Promise.all(eventIds.map(id => api.duplicateEvent(id)));
                
                showNotification(`${eventIds.length} event(s) duplicated successfully!`, 'success');
                await loadMyEvents();
                clearSelection();
                closeModal('bulk-actions-modal');
                
            } catch (error) {
                console.error('Bulk duplicate error:', error);
                showNotification('Failed to duplicate some events. Please try again.', 'error');
            }
        }

        async function bulkDelete() {
            if (selectedEvents.size === 0) return;
            
            if (!confirm(`Are you sure you want to delete ${selectedEvents.size} event(s)? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const eventIds = Array.from(selectedEvents);
                await Promise.all(eventIds.map(id => api.deleteEvent(id)));
                
                showNotification(`${eventIds.length} event(s) deleted successfully!`, 'success');
                await loadMyEvents();
                clearSelection();
                closeModal('bulk-actions-modal');
                
            } catch (error) {
                console.error('Bulk delete error:', error);
                showNotification('Failed to delete some events. Please try again.', 'error');
            }
        }

        // Quick actions
        function showQuickActions(eventId) {
            currentQuickActionEventId = eventId;
            const event = allEvents.find(e => e.id === eventId);
            if (!event) return;
            
            const quickActionsContent = document.getElementById('quick-actions-content');
            quickActionsContent.innerHTML = `
                <div class="quick-actions-list">
                    <h4>${event.title}</h4>
                    <div class="quick-action-buttons">
                        <button class="quick-action-item" onclick="viewEventDetails(${eventId})">
                            <i class="fas fa-eye"></i>
                            <span>View Details</span>
                        </button>
                        <button class="quick-action-item" onclick="editEvent(${eventId})">
                            <i class="fas fa-edit"></i>
                            <span>Edit Event</span>
                        </button>
                        <button class="quick-action-item" onclick="viewRegistrations(${eventId})">
                            <i class="fas fa-users"></i>
                            <span>View Registrations (${event.registered_count || 0})</span>
                        </button>
                        <button class="quick-action-item" onclick="duplicateEvent(${eventId})">
                            <i class="fas fa-copy"></i>
                            <span>Duplicate Event</span>
                        </button>
                        <button class="quick-action-item" onclick="shareEvent(${eventId})">
                            <i class="fas fa-share"></i>
                            <span>Share Event</span>
                        </button>
                        ${event.is_active ? `
                            <button class="quick-action-item warning" onclick="unpublishEvent(${eventId})">
                                <i class="fas fa-eye-slash"></i>
                                <span>Unpublish Event</span>
                            </button>
                        ` : `
                            <button class="quick-action-item success" onclick="publishEvent(${eventId})">
                                <i class="fas fa-eye"></i>
                                <span>Publish Event</span>
                            </button>
                        `}
                        <button class="quick-action-item danger" onclick="deleteEvent(${eventId})">
                            <i class="fas fa-trash"></i>
                            <span>Delete Event</span>
                        </button>
                    </div>
                </div>
            `;
            
            openModal('quick-actions-modal');
        }

        // Individual event actions
        async function publishEvent(eventId) {
            try {
                await api.publishEvent(eventId);
                showNotification('Event published successfully!', 'success');
                await loadMyEvents();
                closeModal('quick-actions-modal');
            } catch (error) {
                console.error('Publish error:', error);
                showNotification('Failed to publish event. Please try again.', 'error');
            }
        }

        async function unpublishEvent(eventId) {
            try {
                await api.unpublishEvent(eventId);
                showNotification('Event unpublished successfully!', 'success');
                await loadMyEvents();
                closeModal('quick-actions-modal');
            } catch (error) {
                console.error('Unpublish error:', error);
                showNotification('Failed to unpublish event. Please try again.', 'error');
            }
        }

        async function duplicateEvent(eventId) {
            try {
                await api.duplicateEvent(eventId);
                showNotification('Event duplicated successfully!', 'success');
                await loadMyEvents();
                closeModal('quick-actions-modal');
            } catch (error) {
                console.error('Duplicate error:', error);
                showNotification('Failed to duplicate event. Please try again.', 'error');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                return;
            }
            
            try {
                await api.deleteEvent(eventId);
                showNotification('Event deleted successfully!', 'success');
                await loadMyEvents();
                closeModal('quick-actions-modal');
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Failed to delete event. Please try again.', 'error');
            }
        }

        function shareEvent(eventId) {
            const event = allEvents.find(e => e.id === eventId);
            if (!event) return;
            
            const eventUrl = `${window.location.origin}/pages/events/event-details.html?id=${eventId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: event.title,
                    text: event.description,
                    url: eventUrl
                });
            } else {
                navigator.clipboard.writeText(eventUrl).then(() => {
                    showNotification('Event URL copied to clipboard!', 'success');
                    closeModal('quick-actions-modal');
                });
            }
        }

        // Navigation functions
        function createNewEvent() {
            window.location.href = 'create-event.html';
        }

        function editEvent(eventId) {
            localStorage.setItem('editEventId', eventId);
            window.location.href = 'create-event.html';
        }

        function viewEventDetails(eventId) {
            localStorage.setItem('selectedEventId', eventId);
            window.location.href = '../events/event-details.html';
        }

        function viewRegistrations(eventId) {
            localStorage.setItem('selectedEventId', eventId);
            window.location.href = 'registrations.html';
        }

        function refreshEvents() {
            loadMyEvents();
        }

        function clearFilters() {
            document.getElementById('status-filter').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('date-filter').value = '';
            document.getElementById('registration-filter').value = '';
            document.getElementById('search-filter').value = '';
            document.getElementById('sort-filter').value = 'date-desc';
            
            applyFilters();
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.dashboard-sidebar');
            sidebar.classList.toggle('show');
        }

        // Utility functions
        function updateEventsCount() {
            const countElement = document.getElementById('events-count');
            const count = filteredEvents.length;
            countElement.textContent = `${count} Event${count !== 1 ? 's' : ''}`;
        }

        function getEventStatus(event) {
            const now = new Date();
            const eventDate = new Date(event.date);
            
            if (!event.is_active) return 'draft';
            if (eventDate > now) return 'published';
            
            const eventEndDate = new Date(eventDate.getTime() + 24 * 60 * 60 * 1000);
            if (eventDate <= now && now <= eventEndDate) return 'active';
            
            return 'completed';
        }

        function getEventStatusText(status) {
            const statusTexts = {
                draft: 'Draft',
                published: 'Published',
                active: 'Live',
                completed: 'Completed',
                cancelled: 'Cancelled'
            };
            return statusTexts[status] || 'Unknown';
        }

        function getRegistrationProgress(event) {
            const registered = event.registered_count || 0;
            const max = event.max_participants;
            return Math.round((registered / max) * 100);
        }

        function calculateRevenue(event) {
            if (!event.entry_fee) return 0;
            const registered = event.registered_count || 0;
            return (registered * event.entry_fee).toFixed(2);
        }

        function showEventsError() {
            const container = document.getElementById('events-container');
            container.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Unable to Load Events</h3>
                    <p>There was a problem loading your events. Please try again.</p>
                    <button class="btn-primary" onclick="loadMyEvents()">
                        <i class="fas fa-retry"></i>
                        Retry
                    </button>
                </div>
            `;
        }

        // Loading state functions
        function showLoadingState(message = 'Loading...') {
            const container = document.getElementById('events-container');
            container.innerHTML = `
                <div class="loading-placeholder">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        function hideLoadingState() {
            // Loading state will be replaced by actual content
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
                document.body.style.overflow = 'auto';
            }
        }

        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            const icon = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            }[type];
            
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="${icon}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="closeNotification(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                closeNotification(notification.querySelector('.notification-close'));
            }, 5000);
        }

        function closeNotification(button) {
            const notification = button.closest('.notification');
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }
    </script>

    <style>
        /* Manage Events Specific Styles */
        .manage-card {
            position: relative;
        }

        .manage-card.selected {
            border-color: var(--demon-red);
            background: rgba(220, 20, 60, 0.05);
            transform: translateY(-2px);
        }

        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid rgba(220, 20, 60, 0.2);
        }

        .event-selection {
            display: flex;
            align-items: center;
        }

        .event-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--demon-red);
        }

        .event-quick-actions {
            position: relative;
        }

        .quick-action-btn {
            background: none;
            border: none;
            color: var(--light-gray);
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .quick-action-btn:hover {
            background: rgba(220, 20, 60, 0.1);
            color: var(--demon-red);
        }

        .event-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--light-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        .stat-value {
            font-weight: 700;
            color: var(--demon-red);
            font-size: 0.9rem;
        }

        /* Bulk Actions Bar */
        .bulk-actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(220, 20, 60, 0.1);
            border: 1px solid rgba(220, 20, 60, 0.3);
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .bulk-info {
            color: var(--white);
            font-weight: 600;
        }

        .bulk-buttons {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* Events Table */
        .events-table-container {
            background: var(--gradient-dark);
            border: 1px solid rgba(220, 20, 60, 0.2);
            border-radius: 16px;
            overflow: hidden;
        }

        .events-table {
            width: 100%;
            border-collapse: collapse;
        }

        .events-table th {
            background: rgba(220, 20, 60, 0.1);
            color: var(--white);
            font-weight: 700;
            padding: var(--spacing-md);
            text-align: left;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(220, 20, 60, 0.3);
        }

        .events-table td {
            padding: var(--spacing-md);
            border-bottom: 1px solid rgba(220, 20, 60, 0.1);
            color: var(--light-gray);
        }

        .events-table tr:last-child td {
            border-bottom: none;
        }

        .events-table tr:hover {
            background: rgba(220, 20, 60, 0.05);
        }

        .events-table tr.selected {
            background: rgba(220, 20, 60, 0.1);
        }

        .event-info .event-title {
            color: var(--white);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .event-info .event-category {
            color: var(--demon-red);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-draft {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .status-published {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-active {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-completed {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .participants-count {
            font-weight: 600;
            color: var(--white);
        }

        .registration-progress {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .progress-bar.small {
            height: 6px;
            width: 60px;
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--light-gray);
            min-width: 30px;
        }

        .revenue-cell {
            font-weight: 600;
            color: #22c55e;
        }

        .table-actions {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--light-gray);
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .action-btn:hover {
            background: rgba(220, 20, 60, 0.1);
            color: var(--demon-red);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(220, 20, 60, 0.3);
            border-radius: 6px;
            overflow: hidden;
        }

        .view-btn {
            background: none;
            border: none;
            color: var(--light-gray);
            padding: 8px 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .view-btn:hover {
            background: rgba(220, 20, 60, 0.1);
            color: var(--white);
        }

        .view-btn.active {
            background: var(--demon-red);
            color: var(--white);
        }

        /* Quick Actions Modal */
        .quick-actions-list h4 {
            color: var(--demon-red);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .quick-action-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .quick-action-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: none;
            border: 1px solid rgba(220, 20, 60, 0.2);
            border-radius: 8px;
            color: var(--white);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: left;
            width: 100%;
        }

        .quick-action-item:hover {
            background: rgba(220, 20, 60, 0.1);
            border-color: var(--demon-red);
        }

        .quick-action-item.warning {
            border-color: rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }

        .quick-action-item.warning:hover {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
        }

        .quick-action-item.success {
            border-color: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .quick-action-item.success:hover {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
        }

        .quick-action-item.danger {
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .quick-action-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
        }

        /* Bulk Actions Modal */
        .bulk-actions-content {
            text-align: center;
        }

        .bulk-actions-content p {
            color: var(--light-gray);
            margin-bottom: var(--spacing-lg);
        }

        .bulk-action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-stats {
                display: none;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .events-grid {
                grid-template-columns: 1fr;
            }
            
            .bulk-actions-bar {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .bulk-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .events-table-container {
                overflow-x: auto;
            }
            
            .bulk-action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
