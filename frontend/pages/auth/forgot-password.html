<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - GameHub</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/auth.css">
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body class="auth-body">
    <!-- Auth Background -->
    <div class="auth-background">
        <div class="auth-particles"></div>
    </div>

    <!-- Back to Login -->
    <div class="auth-back">
        <a href="login.html" class="auth-back-button">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Login</span>
        </a>
    </div>

    <!-- Auth Container -->
    <div class="auth-container">
        <div class="auth-card">
            <!-- Success State -->
            <div id="success-state" style="display: none;">
                <div class="reset-success">
                    <i class="fas fa-check-circle"></i>
                    <h3>Reset Link Sent!</h3>
                    <p>We've sent password reset instructions to your email address.</p>
                </div>
                <div class="auth-links">
                    <div class="auth-link">
                        <a href="login.html">Return to Login</a>
                    </div>
                </div>
            </div>

            <!-- Form State -->
            <div id="form-state">
                <!-- Auth Header -->
                <div class="auth-header">
                    <div class="forgot-password-content">
                        <i class="fas fa-key forgot-password-icon"></i>
                        <h2 class="auth-title">Reset Your Password</h2>
                        <p class="auth-subtitle">Enter your email address and we'll send you a link to reset your password.</p>
                    </div>
                </div>

                <!-- Reset Form -->
                <form id="resetForm" class="auth-form">
                    <!-- Email Input -->
                    <div class="auth-form-group">
                        <label for="email" class="auth-form-label">Email Address</label>
                        <div style="position: relative;">
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                class="auth-form-input" 
                                placeholder="Enter your registered email"
                                required
                                autocomplete="email"
                            >
                            <i class="fas fa-envelope auth-form-icon"></i>
                        </div>
                        <div class="auth-error" id="email-error" style="display: none;"></div>
                    </div>

                    <!-- Reset Button -->
                    <button type="submit" class="auth-button">
                        <i class="fas fa-paper-plane"></i>
                        <span>Send Reset Link</span>
                    </button>

                    <!-- Loading State -->
                    <div id="reset-loading" class="auth-loading" style="display: none;">
                        Sending reset link...
                    </div>
                </form>

                <!-- Additional Info -->
                <div class="auth-links">
                    <div class="auth-link" style="text-align: center; margin-top: var(--spacing-lg);">
                        <p style="color: var(--light-gray); font-size: 0.9rem; margin-bottom: var(--spacing-sm);">
                            Didn't receive the email? Check your spam folder or 
                            <a href="#" onclick="resendResetLink()" style="color: var(--demon-red);">resend the link</a>
                        </p>
                    </div>
                    <div class="auth-link">
                        Remember your password? 
                        <a href="login.html">Back to Login</a>
                    </div>
                    <div class="auth-link">
                        Don't have an account? 
                        <a href="register.html">Join GameHub</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../config/api-config.js"></script>
    <script src="../../assets/js/api.js"></script>
    <script src="../../assets/js/auth.js"></script>
    <script src="../../assets/js/utils.js"></script>
    
    <script>
        let lastSubmittedEmail = '';

        // Initialize forgot password page
        document.addEventListener('DOMContentLoaded', function() {
            setupResetForm();
            checkExistingAuth();
            setupFormValidation();
        });

        // Check if user is already authenticated
        function checkExistingAuth() {
            if (auth.isAuthenticated()) {
                const user = auth.getCurrentUser();
                if (user) {
                    window.location.href = `../${user.role}/dashboard.html`;
                }
            }
        }

        // Setup reset form
        function setupResetForm() {
            const resetForm = document.getElementById('resetForm');
            
            resetForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!validateForm()) {
                    return;
                }

                await handlePasswordReset();
            });

            // Auto-focus email input
            document.getElementById('email').focus();
        }

        // Handle password reset process
        async function handlePasswordReset() {
            const email = document.getElementById('email').value.trim();
            lastSubmittedEmail = email;

            try {
                showLoadingState(true);
                clearErrors();

                // Since this is a demo, we'll simulate the password reset
                // In production, this would call your actual API
                await simulatePasswordReset(email);

                showSuccessState();

            } catch (error) {
                console.error('Password reset error:', error);
                showErrorMessage('Failed to send reset email. Please try again.');
            } finally {
                showLoadingState(false);
            }
        }

        // Simulate password reset (replace with actual API call)
        async function simulatePasswordReset(email) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // In production, replace this with:
            // await api.requestPasswordReset(email);
            
            console.log(`Password reset link would be sent to: ${email}`);
        }

        // Show success state
        function showSuccessState() {
            document.getElementById('form-state').style.display = 'none';
            document.getElementById('success-state').style.display = 'block';
        }

        // Resend reset link
        async function resendResetLink() {
            if (!lastSubmittedEmail) {
                showErrorMessage('Please enter your email address first.');
                return;
            }

            try {
                await simulatePasswordReset(lastSubmittedEmail);
                showSuccessMessage('Reset link resent successfully!');
            } catch (error) {
                console.error('Resend error:', error);
                showErrorMessage('Failed to resend reset link. Please try again.');
            }
        }

        // Form validation
        function validateForm() {
            const email = document.getElementById('email').value.trim();
            let isValid = true;

            clearErrors();

            // Email validation
            if (!email) {
                showFieldError('email', 'Email is required');
                isValid = false;
            } else if (!ValidationUtils.isValidEmail(email)) {
                showFieldError('email', 'Please enter a valid email address');
                isValid = false;
            }

            return isValid;
        }

        function setupFormValidation() {
            const emailInput = document.getElementById('email');

            emailInput.addEventListener('blur', function() {
                const email = this.value.trim();
                if (email && !ValidationUtils.isValidEmail(email)) {
                    showFieldError('email', 'Please enter a valid email address');
                    this.classList.add('error');
                } else {
                    clearFieldError('email');
                    this.classList.remove('error');
                }
            });

            emailInput.addEventListener('input', function() {
                clearFieldError('email');
                this.classList.remove('error');
            });
        }

        // Show field-specific error
        function showFieldError(fieldName, message) {
            const errorElement = document.getElementById(`${fieldName}-error`);
            const inputElement = document.getElementById(fieldName);
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            if (inputElement) {
                inputElement.classList.add('error');
            }
        }

        // Clear field-specific error
        function clearFieldError(fieldName) {
            const errorElement = document.getElementById(`${fieldName}-error`);
            const inputElement = document.getElementById(fieldName);
            
            if (errorElement) {
                errorElement.style.display = 'none';
            }
            
            if (inputElement) {
                inputElement.classList.remove('error');
            }
        }

        // Clear all errors
        function clearErrors() {
            const errorElements = document.querySelectorAll('.auth-error');
            const inputElements = document.querySelectorAll('.auth-form-input');
            
            errorElements.forEach(element => {
                element.style.display = 'none';
            });
            
            inputElements.forEach(element => {
                element.classList.remove('error');
            });
        }

        // Show loading state
        function showLoadingState(show) {
            const submitButton = document.querySelector('.auth-button');
            const loadingElement = document.getElementById('reset-loading');
            
            if (show) {
                submitButton.style.display = 'none';
                loadingElement.style.display = 'block';
            } else {
                submitButton.style.display = 'block';
                loadingElement.style.display = 'none';
            }
        }

        // Message functions
        function showSuccessMessage(message) {
            showNotification(message, 'success');
        }

        function showErrorMessage(message) {
            showNotification(message, 'error');
        }

        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.auth-notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = `auth-notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="${getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                max-width: 400px;
                background: var(--pure-black);
                border: 1px solid ${type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : 'var(--demon-red)'};
                border-radius: 12px;
                padding: var(--spacing-md);
                box-shadow: var(--shadow-dark);
                z-index: 10000;
                transform: translateX(100%);
                opacity: 0;
                transition: all var(--transition-normal);
                color: var(--white);
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 100);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.transform = 'translateX(100%)';
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        function getNotificationIcon(type) {
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            return icons[type] || icons.info;
        }
    </script>
</body>
</html>
